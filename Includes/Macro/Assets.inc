                ifndef _MACRO_ASSETS_
                define _MACRO_ASSETS_
; -----------------------------------------
; расчёт адреса расположения ресурса
; In:
; Out:
;   IX - адрес структуры FAssets
; Corrupt:
; -----------------------------------------
ASSETS_ADR      macro ID?
                LD IX, Adr.AssetsTable | (ID? << 3)
                endm

; -----------------------------------------
; установка загрузки ресурса
; In:
;   ID?      - идентификатор ресурса
;   Page?    - страница расположения ресурса
;   Address? - адрес расположения ресурса
; Out:
;   IX       - адрес структуры FAssets
; Corrupt:
; -----------------------------------------
SET_LOAD_ASSETS macro ID?, Page?, Address?
                SET_PAGE_6                                                      ; включить страницу (с хранением данных о ресурсах)
                
                ; подготовка к загрузке
                ASSETS_ADR ID?

                ; A - номер страницы
                ;
                ;      7    6    5    4    3    2    1    0
                ;   +----+----+----+----+----+----+----+----+
                ;   | 0  | 0  | 0  | A7 | A6 | A5 | A4 | A3 |
                ;   +----+----+----+----+----+----+----+----+
                ;
                ;   A7-A3   [4..0]      - страница памяти 16кб
                ;                         часть адреса хранения битовой маски
                ;   
                ; HL - адрес
                ;
                ;   +----+----+----+----+----+----+----+----+   +----+----+----+----+----+----+----+----+
                ;  | 15 | 14 | 13 | 12 | 11 | 10 |  9 |  8 |   |  7 |  6 |  5 |  4 |  3 |  2 |  1 |  0 |
                ;  +----+----+----+----+----+----+----+----+   +----+----+----+----+----+----+----+----+
                ;  | 1  | 1  | A2 | A1 | A0 | B2 | B1 | B0 |   | X  | X  | X  | X  | X  | X  | X  | X  |
                ;  +----+----+----+----+----+----+----+----+   +----+----+----+----+----+----+----+----+
                ;
                ;   A2-A0   [13..11]    - адрес
                ;                         часть адреса хранения битовой маски
                ;   B2-B0   [10..8]     - адрес
                ;                         номер бита в байте (обратный)

                ; сохранение линейного адреса размещения ресурса
                LD (IX + FAssets.Address.Page), Page?
                LD (IX + FAssets.Address.Adr.Low), LOW Address?
                LD (IX + FAssets.Address.Adr.High), 0xC0 | HIGH Address?
                endm
; -----------------------------------------
; загрузка ресурса
; In:
;   ID? - идентификатор ресурса
;   IX  - адрес структуры FAssets
; Out:
; Corrupt:
; -----------------------------------------
LOAD_ASSETS     macro ID?
                LD A, ID?
                ; -----------------------------------------
                ; загрузка ресурса
                ; In:
                ;   A  - идентификатор ресурса
                ; Out:
                ;   HL - адрес загруженного ресурса
                ;   IX - адрес структуры FAssets
                ;   флаг переполнения установлен, если не удалось найти необходимого размера непрерывную область ОЗУ
                ;   иначе установлена страница загруженого ресурса, рег. пара HL указывает адрес
                ; Note:
                ;   необходимо включить страницу с данными о доступной ОЗУ
                ; -----------------------------------------
                CALL AssetsManager.Load                                         ; загрузка ресурса
                CALL C, AssetsManager.TryToFree                                 ; попытка освободить память под ресурса, в случае ошибочной загрузки
                DEBUG_BREAK_POINT_C                                             ; ошибка загрузки ресурса
                endm
; -----------------------------------------
; загрузка ресурса и запуск
; In:
;   ID? - идентификатор ресурса
;   IX  - адрес структуры FAssets
; Out:
; Corrupt:
; -----------------------------------------
LOAD_EXE_ASSETS macro ID?
                LD A, ID?
                CALL AssetsManager.Load                                         ; загрузка ресурса
                CALL C, AssetsManager.TryToFree                                 ; попытка освободить память под ресурса, в случае ошибочной загрузки
                DEBUG_BREAK_POINT_C                                             ; ошибка загрузки ресурса
                JP (HL)                                                         ; запуск загруженного блока
                endm
; -----------------------------------------
; загрузка ресурса и запуск
; In:
;   ID? - идентификатор ресурса
;   IX  - адрес структуры FAssets
; Out:
; Corrupt:
; -----------------------------------------
EXE_ASSETS_NOT_PARAM macro ID?, Func?
                LD HL, .Continue+3
                PUSH HL
                PUSH_PAGE                                                       ; сохранение номера страницы в стеке
                LD HL, Func.PopPage
                PUSH HL
                LD A, Func?
                PUSH AF
                LD A, ID?
.Continue       JP Func.ExeAssetCode
                endm
; -----------------------------------------
; отметить область ОЗУ как занятая
; In:
;   Page?    - страница области
;   Address? - адрес области
;   Size?    - размер области (занимаемой)
; Out:
; Corrupt:
; -----------------------------------------
MARK_RAM        macro Page?, Address?, Size?
                ; -----------------------------------------
                ; отметить занятую область данными в доступной ОЗУ (принудительно)
                ; In:
                ;   HL - адрес расположения бита линейного адреса
                ;   B  - номер бита линейного адреса
                ;   E  - количество блоков по 256 байт
                ; -----------------------------------------
                LD HL, (HIGH Adr.AvailableMem << 8 ) | ((((Page?) << 14) | ((Address?) & 0x3FFF)) >> 11)
                LD B, ((~((((Page?) << 14) | ((Address?) & 0x3FFF)) >> 8)) & 0x07)+1
                LD E, (((Size?) % TRDOS.SECTOR_SIZE > 0) & 0x01) + ((Size?) >> 8)
                CALL AssetsManager.Mark.Force                                   ; отметить область ОЗУ как занятая
                endm

                endif ; ~_MACRO_ASSETS_
